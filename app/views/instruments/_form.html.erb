<section class="widget">
  <header>
    <h4><i class="icon-edit"></i> Instruments</h4>
  </header>
  <div class="body">
    <%= form_for @instrument do |f| %>
      <% if @instrument.errors.any? %>
        <div class="error_messages">
          <h2><%= pluralize(@instrument.errors.count, "error") %> prohibited this survey from being saved:</h2>
          <ul>
          <% @instrument.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
          </ul>
        </div>
      <% end %>

      <div class="field bottom-buffer">
        <%= f.label :title, 'Instrument Title' %><br />
        <%= f.text_field :title, class: 'form-control' %>
      </div>

      <div class="field bottom-buffer">
        <%= f.label :language %>
        <%= f.select(:language, options_for_select(Settings.languages, @instrument.language)) %>
      </div>

      <div ng-controller="QuestionsCtrl" ng-init="init(<%= @instrument.id %>)">
        <input type="search" ng-model="q" placeholder="Search questions..." class="form-control bottom-buffer">
        <div ui-sortable="sortableOptions" ng-model="questions">
          <div class="row" ng-repeat="question in questions | filter:q">
            <div class="col-md-3">
              <span class="tiny-column"><h4 style="display:inline"><strong>{{question.number_in_instrument}}</strong></h4></span> 
              <div class="icheckbox_square-grey" ng-click="toggleSelection(question)" ng-class="{checked: questionSelected(question)}"></div>
              <a class="btn btn-default move-question"><i class="icon-move"></i></a>
              <a class="btn btn-default" ng-click="editQuestion(question)"><i class="icon-edit"></i></a>
              <a class="btn btn-danger" ng-click="deleteQuestion(question)"><i class="icon-trash"></i></a>
            </div>
            <div class="col-md-9">
              <div ng-hide="edit_question == question" class="widget">
                <header>
                  <strong><h4>{{question.question_identifier}}</h4></strong> 
                  <div class="actions">
                    <a class="btn btn-xs btn-inverse"><i class="icon-arrow-down"></i> View more</a>
                  </div> 
                </header>
                <div class="body">
                  {{question.text}}
                </div>
              </div>
              <div ng-show="edit_question == question">
                <section class="widget widget-tabs">
                  <header>
                    <ul class="nav nav-tabs">
                      <li><a href=".tab-general" data-toggle="tab">General</a></li>
                      <li><a href=".tab-logic" data-toggle="tab">Logic</a></li>
                      <li><a href=".tab-advanced" data-toggle="tab">Advanced</a></li>
                    </ul>
                  </header>
                  <div class="body tab-content">
                    <div class="tab-general tab-pane active">
                      <form class="form-horizontal label-left">
                        <fieldset>
                          <div class="control-group">
                            <label for="question-identifier" class="control-label">Question Identifier</label>
                            <div class="controls form-group">
                              <input type="text" class="form-control" name="question-identifier" ng-model="question.question_identifier">
                            </div>
                            <label for="question-type" class="control-label">Question Type</label>
                            <div class="controls form-group">
                              <select 
                                chosen
                                class="select2-container select-block-level"
                                data-placeholder="Select a question type..."
                                no-results-text="'This does not match any valid question type'"
                                name="question-type"
                                ng-model="question.question_type"
                                ng-options="type for type in questionTypes()">
                              </select>
                            </div>
                            <label for="content" class="control-label">Content</label>
                            <div class="controls form-group">
                              <textarea id="content" rows="4" ng-model="question.text" class="form-control"></textarea>
                            </div>
                            <div ng-show="questionTypesWithOptions(question.question_type)">
                              <div ng-controller="OptionsCtrl" ng-init="init(<%= @instrument.id %>, question.id)">
                              <fieldset>
                                <legend class="section">
                                  Options 
                                  <a ng-click="addOption()" class="btn btn-xs btn-primary pull-right">
                                    <i class="icon-plus"></i> Add Option
                                  </a>
                                </legend>
                                  <div class="controls form-group">
                                    <ol>
                                      <li ng-repeat="option in options">
                                        <div class="input-group">
                                          <input type="text" class="form-control" ng-model="option.text"> 
                                          <div class="input-group-btn">
                                            <button ng-click="removeOption(option)" class="btn btn-danger">
                                              <i class="icon-trash"></i>
                                            </button>
                                          </div>
                                        </div>
                                      </li>
                                    </ol>
                                </div>
                                </fieldset>
                              </div>
                            </div>
                          </div>
                        </fieldset>
                      </form>
                    </div>
                    <div class="tab-logic tab-pane">Logic</div>
                    <div class="tab-advanced tab-pane">
                      <fieldset>
                        <legend class="section">
                          Regular Expression Match
                        </legend>
                        <div>
                          <p class="text-muted">A regular expression is a standard for describing text format.  If a regular expression
                          is provided for this question, then the response must match this regular expression for it
                          to be considered valid.</p>
                          <label for="question-regex" class="control-label">Regular Expression</label>
                          <div class="controls form-group">
                            <input type="text" name="question-regex" class="form-control" ng-model="question.reg_ex_validation">
                          </div>
                        </div>
                      </fieldset>
                    </div>
                    <div class="form-actions">
                      <a class="btn btn-success pull-right" ng-click="saveQuestion()">Save</a>
                      <a class="btn btn-danger pull-right" ng-click="cancelQuestion()">Cancel</a>
                    </div>
                  </div>
                </section>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="top-buffer">
        <a class="btn btn-success" ng-click="newQuestion()"><i class="icon-plus"></i> Add Question</a>
      </div>

      <%= f.fields_for :questions do |builder| %>
        <%= render 'question_fields', f: builder %>
      <% end %>
      <%= link_to_add_fields "Add Question", f, :questions, class: 'btn btn-success top-buffer' %>
      
      <div class="top-buffer pull-right">
        <%= f.submit class: 'btn btn-primary btn-large' %>
      </div>
    <% end %>
  </div>
</section>
